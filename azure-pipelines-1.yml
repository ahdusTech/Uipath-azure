trigger:
- main

variables:
  group: UiPath

stages:
- stage: Build
  displayName: Create build artifact
  jobs:
  - job: BuildArtifact
    pool:
      name: Azure-UIP
    steps:
    - task: UiPathPack@3
      inputs:
        versionType: 'AutoVersion'
        projectJsonPath: '$(Build.SourcesDirectory)/project.json'
        orchestratorConnection: 'Azure-UIpath'
        outputPath: '$(Build.ArtifactStagingDirectory)/Output'
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'
    - task: UiPathDeploy@3
      inputs:
        orchestratorConnection: 'Azure-UIpath'
        packagesPath: '$(Build.ArtifactStagingDirectory)/Output'
        folderName: 'Shared'

- stage: Asset
  displayName: Create Assets
  jobs:
    - job: CreateAssets
      pool:
        name: Azure-UIP
      steps:
        - task: UiPathAssets@3
          inputs:
            orchestratorConnection: 'Azure-UIpath'
            folderName: 'Shared'
            assetActionType: 'Deploy'
            csvFile: '$(Build.SourcesDirectory)/Data/Assets.csv'

- stage: DeployDEV
  displayName: Deploy build artifact to DEV
  dependsOn: Build
  condition: succeeded()
  jobs:
    - deployment: deployDEV
      displayName: Restore package to DEV Orchestrator
      pool:
        name: Azure-UIP
      environment: 'DEV'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: NuGetCommand@2
                inputs:
                  command: 'restore'
                  restoreSolution: '**/*.sln'
                  feedsToUse: 'select'

- stage: RunTests
  displayName: Run UiPath Tests
  jobs:
  - job: RunUiPathTests
    displayName: Run UiPath Tests
    pool:
      vmImage: 'windows-2019' # Specify a Windows image with UiPath and other required tools installed.
    steps:
    - task: NuGetToolInstaller@1
      displayName: 'Install NuGet'
      inputs:
        versionSpec: '5.x'
    - task: NuGetCommand@2
      displayName: 'Restore NuGet packages'
      inputs:
        command: 'restore'
        restoreSolution: '**/*.sln'
        feedsToUse: 'select'
        vstsFeed: '<your VSTS feed>' # Specify the NuGet feed containing the UiPath.Testing.Activity package.
    - task: DownloadBuildArtifacts@0
      displayName: 'Download Test Suite project'
      inputs:
        buildType: 'current'
        downloadType: 'specific'
        artifactName: 'TestSuite' # Specify the name of the artifact containing the UiPath Test Suite project.
        downloadPath: '$(Build.ArtifactStagingDirectory)/TestSuite'
    - script: |
        cd '$(Build.ArtifactStagingDirectory)/TestSuite'
        UiPath.Testing.Activity.exe -uipathTestSuite -testSuitePath 'Tests.xml' -resultPath 'Results.xml'
      displayName: 'Run UiPath Tests'